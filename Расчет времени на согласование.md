#Управляемые формы

&НаКлиенте
Процедура ВыполнитьДействие(Команда)
	
	Результат = ПолучитьВремяСогласования(НачалоСогласования, ОкончаниеСогласования); //Параметры - реквизиты формы.
	
	Сообщить(Формат(Результат, "ЧРД=:"));
	
КонецПроцедуры 

&НаСервере
Функция ПолучитьВремяСогласования(Знач НачалоСогласования, Знач ОкончаниеСогласования)
	
	СекундСогласования = 0;

	Если ОкончаниеСогласования = NULL ИЛИ НачалоСогласования > ОкончаниеСогласования Тогда 
		Возврат 0;
	КонецЕсли;	
	
	Если День(НачалоСогласования) = День(ОкончаниеСогласования) Тогда 
		
		НачалоРабочегоДня       = НачалоДня(НачалоСогласования) + 3600 * 9;  //Начало рабочего дня - 9:00
		КонецПервойПоловиныДня  = НачалоДня(НачалоСогласования) + 3600 * 13; //Начало обеда - 13:00
		НачалоВторойПоловиныДня = НачалоДня(НачалоСогласования) + 3600 * 14; //Окончание обеда - 14:00
		КонецРабочегоДня        = НачалоДня(НачалоСогласования) + 3600 * 18; //Конец рабочего дня - 18:00
		
		Если (НачалоСогласования < НачалоРабочегоДня И ОкончаниеСогласования < НачалоРабочегоДня) //Согласования не в рамках рабочего дня
			ИЛИ (НачалоСогласования > КонецРабочегоДня И ОкончаниеСогласования > КонецРабочегоДня) Тогда 
			
			Возврат 0;
			
		КонецЕсли;	
		
		//Если согласование фактически запустили раньше начала рабочего дня, будем считать началом согласования - 9:00
		Если НачалоСогласования < НачалоРабочегоДня Тогда  
			НачалоСогласования = НачалоРабочегоДня;
		КонецЕсли;
		
		//Если согласование завершилось после рабочего дня, будем считать окончанием согласования - 18:00
		Если ОкончаниеСогласования > КонецРабочегоДня Тогда  
			ОкончаниеСогласования = КонецРабочегоДня;
		КонецЕсли;
				
		Если (НачалоСогласования <= КонецПервойПоловиныДня И ОкончаниеСогласования > НачалоВторойПоловиныДня)
			ИЛИ (НачалоСогласования < КонецПервойПоловиныДня И ОкончаниеСогласования >= НачалоВторойПоловиныДня) Тогда //Вычитаем время на обед
			
			СекундСогласования = ОкончаниеСогласования - НачалоСогласования - 3600;
			
		ИначеЕсли НачалоСогласования < КонецПервойПоловиныДня И (ОкончаниеСогласования >= КонецПервойПоловиныДня И ОкончаниеСогласования <= НачалоВторойПоловиныДня) Тогда
			
			СекундСогласования = КонецПервойПоловиныДня - НачалоСогласования;
			
		ИначеЕсли (НачалоСогласования >= КонецПервойПоловиныДня И НачалоСогласования <= НачалоВторойПоловиныДня) И ОкончаниеСогласования > НачалоВторойПоловиныДня Тогда
			
			СекундСогласования = ОкончаниеСогласования - НачалоВторойПоловиныДня;
			
		ИначеЕсли (НачалоСогласования >= КонецПервойПоловиныДня И НачалоСогласования <= НачалоВторойПоловиныДня) 
			И (ОкончаниеСогласования >= КонецПервойПоловиныДня И ОкончаниеСогласования <= НачалоВторойПоловиныДня) Тогда
			
			Возврат 0;
			
		Иначе
			
			СекундСогласования = ОкончаниеСогласования - НачалоСогласования;
			
		КонецЕсли;
		
	Иначе
		
		ДатаСогласования = НачалоСогласования;
		
		Пока ДатаСогласования < ОкончаниеСогласования Цикл 
			
			Если ДеньНедели(ДатаСогласования) < 6 Тогда 
			
				Если День(ДатаСогласования) = День(ОкончаниеСогласования) Тогда
					
					НачалоРабочегоДня       = НачалоДня(ДатаСогласования) + 3600 * 9;  
					КонецПервойПоловиныДня  = НачалоДня(ДатаСогласования) + 3600 * 13; 
					НачалоВторойПоловиныДня = НачалоДня(ДатаСогласования) + 3600 * 14; 
					КонецРабочегоДня        = НачалоДня(ДатаСогласования) + 3600 * 18; 
					
					Если ОкончаниеСогласования < НачалоРабочегоДня Тогда
						
						Прервать;;
						
					ИначеЕсли ОкончаниеСогласования > КонецРабочегоДня Тогда
						
						СекундСогласования = СекундСогласования + 3600 * 8;	
					
					ИначеЕсли ОкончаниеСогласования >= НачалоВторойПоловиныДня Тогда
						
						СекундСогласования = СекундСогласования + (ОкончаниеСогласования - ДатаСогласования) - 3600;
						
					ИначеЕсли ОкончаниеСогласования >= КонецПервойПоловиныДня И ОкончаниеСогласования <= НачалоВторойПоловиныДня Тогда
						
						СекундСогласования = СекундСогласования + 3600 * 4;
						
					Иначе
						
						СекундСогласования = СекундСогласования + (ОкончаниеСогласования - ДатаСогласования);
						
					КонецЕсли;
					
				Иначе
					
					Если СекундСогласования = 0 Тогда //Считаем что это первый день согласования
						
						НачалоРабочегоДня       = НачалоДня(ДатаСогласования) + 3600 * 9;
						КонецПервойПоловиныДня  = НачалоДня(ДатаСогласования) + 3600 * 13; 
						НачалоВторойПоловиныДня = НачалоДня(ДатаСогласования) + 3600 * 14;
						КонецРабочегоДня        = НачалоДня(ДатаСогласования) + 3600 * 18;
						
						Если ДатаСогласования < НачалоРабочегоДня Тогда
							
							СекундСогласования = 3600 * 8; //Сразу определяем как 8 часов согласования
							
						Иначе
							
							Если ДатаСогласования <= КонецПервойПоловиныДня Тогда //Вычитаем обед
								
								СекундСогласования = КонецРабочегоДня - ДатаСогласования - 3600;
								
							ИначеЕсли ДатаСогласования >= НачалоВторойПоловиныДня Тогда
								
								СекундСогласования = КонецРабочегоДня - ДатаСогласования;
								
							Иначе
								
								СекундСогласования = 3600 * 4;
								
							КонецЕсли;	
							
						КонецЕсли;
						
					Иначе
						
						СекундСогласования = СекундСогласования + 3600 * 8; //Добавляем еще день
						
					КонецЕсли;	
					
				КонецЕсли;
			
			КонецЕсли;
			
			ДатаСогласования = КонецДня(ДатаСогласования) + 1 + 3600 * 9;
			
		КонецЦикла;	

	КонецЕсли; 
	
	ЧасовСогласования = Цел(СекундСогласования / 3600);
	МинутСогласования = Цел((СекундСогласования - ЧасовСогласования * 3600) / 60);
	
	ВремяСогласования = ЧасовСогласования + МинутСогласования / 100; //В формате: 8,35 (где целая часть - часы, дробная - минуты)

	Возврат ВремяСогласования

КонецФункции